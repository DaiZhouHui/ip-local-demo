name: Update IP Country Database

on:
  # 1. å®šæ—¶è§¦å‘ï¼šæ¯å‘¨ä¸€åŒ—äº¬æ—¶é—´ä¸Šåˆ11ç‚¹è¿è¡Œ (UTCæ—¶é—´å‘¨ä¸€å‡Œæ™¨3ç‚¹)
  schedule:
    - cron: '0 3 * * 1'
  # 2. å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµï¼ˆåœ¨GitHubç½‘é¡µç‚¹å‡»è¿è¡Œï¼‰
  workflow_dispatch:
    inputs:
      skip_commit:
        description: 'è·³è¿‡è‡ªåŠ¨æäº¤ï¼ˆä»…æµ‹è¯•æ„å»ºï¼‰'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

# è®¾ç½®å¿…è¦çš„å†™å…¥æƒé™ï¼ˆç”¨äºæ¨é€æ›´æ–°ï¼‰
permissions:
  contents: write

jobs:
  update-database:
    runs-on: ubuntu-latest  # ä½¿ç”¨GitHubæä¾›çš„æœ€æ–°Ubuntuç¯å¢ƒ
    
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»“åº“ä»£ç 
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          # è·å–å…¨éƒ¨æäº¤å†å²ï¼Œä»¥ä¾¿æ­£ç¡®ç”Ÿæˆæ–°æäº¤
          fetch-depth: 0
          
      # æ­¥éª¤2ï¼šè®¾ç½®Pythonç¯å¢ƒ
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'  # å»ºè®®ä½¿ç”¨ä¸æœ¬åœ°ä¸€è‡´çš„ç‰ˆæœ¬
          
      # æ­¥éª¤3ï¼šå®‰è£…Pythonä¾èµ–
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          # åˆ—å‡ºä½ çš„è„šæœ¬æ‰€éœ€çš„æ‰€æœ‰ä¾èµ–
          pip install ipaddress  # é€šå¸¸æ˜¯å†…ç½®çš„ï¼Œä½†æ˜ç¡®å£°æ˜æ›´å®‰å…¨
          
      # æ­¥éª¤4ï¼šè¿è¡Œæ•°æ®åº“æ„å»ºè„šæœ¬ï¼ˆä½¿ç”¨å®‰å…¨å¯†é’¥ï¼‰
      - name: ğŸ› ï¸ Build IP database
        env:
          # å…³é”®ï¼šä»GitHub Secretsè¯»å–ä½ çš„MaxMindè®¸å¯è¯å¯†é’¥
          MAXMIND_LICENSE_KEY: ${{ secrets.MAXMIND_LICENSE_KEY }}
        run: |
          echo "å¼€å§‹æ„å»ºIPå›½å®¶æ•°æ®åº“..."
          # ç¡®ä¿è„šæœ¬ä½¿ç”¨ç¯å¢ƒå˜é‡ä¸­çš„å¯†é’¥
          # å¦‚æœä½ çš„è„šæœ¬éœ€è¦ä»ç¯å¢ƒå˜é‡è¯»å–ï¼Œè¯·ç›¸åº”ä¿®æ”¹
          # è¿™é‡Œå‡è®¾ä½ çš„è„šæœ¬å·²ä¿®æ”¹ä¸ºä»ç¯å¢ƒå˜é‡è¯»å–
          python build_database_three_tiers.py
          echo "æ•°æ®åº“æ„å»ºå®Œæˆï¼"
          
          # æ˜¾ç¤ºç”Ÿæˆçš„æ–‡ä»¶ä¿¡æ¯
          echo "=== ç”Ÿæˆçš„æ–‡ä»¶ä¿¡æ¯ ==="
          ls -lh database.json
          echo "===================="
          
      # æ­¥éª¤5ï¼šæ£€æŸ¥æ–‡ä»¶å˜åŒ–ï¼ˆç”¨äºåˆ¤æ–­æ˜¯å¦éœ€è¦æäº¤ï¼‰
      - name: ğŸ” Check for changes
        id: check-changes
        run: |
          git status --porcelain
          if [[ -n $(git status --porcelain) ]]; then
            echo "æ•°æ®åº“æ–‡ä»¶å·²æ›´æ–°"
            echo "changes_detected=true" >> $GITHUB_OUTPUT
            echo "changes_summary=$(git status --porcelain)" >> $GITHUB_OUTPUT
          else
            echo "æ•°æ®åº“æ–‡ä»¶æ— å˜åŒ–"
            echo "changes_detected=false" >> $GITHUB_OUTPUT
          fi
          
      # æ­¥éª¤6ï¼šé…ç½®Gitå¹¶æäº¤æ›´æ–°ï¼ˆå¦‚æœæ£€æµ‹åˆ°å˜åŒ–ä¸”ä¸è·³è¿‡ï¼‰
      - name: ğŸ’¾ Commit and push updates
        if: steps.check-changes.outputs.changes_detected == 'true' && github.event.inputs.skip_commit != 'true'
        run: |
          # é…ç½®Gitç”¨æˆ·ä¿¡æ¯ï¼ˆä½¿ç”¨GitHub Actionsçš„æœºå™¨äººèº«ä»½ï¼‰
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # æ·»åŠ æ‰€æœ‰æ›´æ”¹çš„æ–‡ä»¶ï¼ˆä¸»è¦æ˜¯database.jsonï¼‰
          git add .
          
          # ç”Ÿæˆæœ‰æ„ä¹‰çš„æäº¤ä¿¡æ¯
          commit_msg="ğŸ¤– chore: è‡ªåŠ¨æ›´æ–°IPå›½å®¶æ•°æ®åº“ [$(date +'%Y-%m-%d')]"
          
          # è·å–æ–‡ä»¶å˜åŒ–è¯¦æƒ…ï¼ˆç”¨äºæäº¤ä¿¡æ¯ï¼‰
          file_changes=$(git diff --cached --name-only)
          db_size=$(ls -lh database.json | awk '{print $5}')
          commit_msg+="\n\næ›´æ–°æ–‡ä»¶: $file_changes"
          commit_msg+="\næ•°æ®åº“å¤§å°: $db_size"
          commit_msg+="\n[skip ci]"  # é¿å…è§¦å‘å…¶ä»–CI/CD
          
          # æäº¤å¹¶æ¨é€
          git commit -m "$commit_msg"
          git push
          
      # æ­¥éª¤7ï¼šå¦‚æœæ²¡æœ‰å˜åŒ–ï¼Œè¾“å‡ºæç¤º
      - name: â„¹ï¸ No changes detected
        if: steps.check-changes.outputs.changes_detected == 'false'
        run: |
          echo "âœ… æ•°æ®åº“å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ–°ã€‚"
          echo "å½“å‰æ•°æ®åº“ä¿¡æ¯:"
          ls -lh database.json
          
      # æ­¥éª¤8ï¼šå¦‚æœé€‰æ‹©è·³è¿‡æäº¤ï¼Œè¾“å‡ºæç¤º
      - name: âš ï¸ Skipped commit (manual mode)
        if: steps.check-changes.outputs.changes_detected == 'true' && github.event.inputs.skip_commit == 'true'
        run: |
          echo "â¸ï¸ æ£€æµ‹åˆ°æ•°æ®åº“å˜åŒ–ï¼Œä½†å·²è·³è¿‡è‡ªåŠ¨æäº¤ï¼ˆæ‰‹åŠ¨æ¨¡å¼ï¼‰ã€‚"
          echo "å˜åŒ–æ‘˜è¦:"
          git status --porcelain
          echo ""
          echo "ä½ å¯ä»¥ï¼š"
          echo "1. æ‰‹åŠ¨æäº¤è¿™äº›æ›´æ”¹"
          echo "2. é‡æ–°è¿è¡Œå·¥ä½œæµå¹¶å–æ¶ˆé€‰æ‹©'skip_commit'é€‰é¡¹"